# Query de Monitoramento do Atendimento CREA-SP

## Visão Geral

Esta query foi desenvolvida para atender às necessidades de Business Intelligence (BI) do setor de atendimento do CREA-SP (Conselho Regional de Engenharia e Agronomia de São Paulo). O objetivo principal é extrair, transformar e consolidar dados de múltiplas tabelas do banco DB2 para fornecer uma visão unificada e analítica dos protocolos de atendimento, permitindo o acompanhamento de métricas essenciais como SLA, status de solicitações, distribuição por unidades regionais e categorização de atendimentos.

A estrutura utiliza CTEs (Common Table Expressions) para otimizar a performance e organizar logicamente as transformações de dados, implementando regras de negócio complexas que refletem o fluxo operacional do CREA-SP. A query processa informações desde a abertura de protocolos até sua finalização, incluindo dados de pagamento, atribuição de responsáveis e cálculo de prazos.

## Código da Query

```sql
-- Query Atendimento, atualizada em 02/09/2025 a pedido do Rodnei, com alinhamento feito em reunião com a equipe HEPTA
-- Criei índices e CTEs para conseguir otimizar a execução da query, devido ao seu longo tempo de execução sem essas implementações

-- PRIMEIRO: Criar índices 
/*
CREATE INDEX IDX_PROT_DRAFT_FINISHED ON DB2INET.TB_PROTOCOLO_CREANET (DRAFT, FINISHED, CD_PROT);
CREATE INDEX IDX_STATUS_PROT_CD ON DB2INET.TB_STATUS_PROTOCOLO_CREANET (CD_PROT, CD_STAT_PROT);
CREATE INDEX IDX_FUNC_UPPER_SAM ON DB2INET.TB_FUNCIONARIO (UPPER(SAMACCOUNTNAME), DELETED);
CREATE INDEX IDX_BOLETO_CD_PROC ON DB2INET.TB_BOLETO (CD_PROC);
CREATE INDEX IDX_UNIDADE_DESC ON DB2INET.TB_UNIDADE (DESC_UNI, DESC_SIGLA);
*/

WITH 
-- CTE 1: Pré-filtrar e obter último status de uma vez só
ULTIMO_STATUS AS (
    SELECT 
        SP.CD_PROT,
        SP.DS_OBSERVACOES,
        SP.DT_STATUS,
        SP.ATRIBUIDO,
        SP.CD_TP_STATUS_PROT,
        SP.CD_STAT_PROT,
        ROW_NUMBER() OVER (PARTITION BY SP.CD_PROT ORDER BY SP.CD_STAT_PROT DESC) AS RN
    FROM DB2INET.TB_STATUS_PROTOCOLO_CREANET SP
),
-- CTE 2: Identificar funcionários com Acervo
FUNCIONARIOS_ACERVO AS (
    SELECT DISTINCT 
        UPPER(SP.ATRIBUIDO) AS ATRIBUIDO_UPPER
    FROM DB2INET.TB_PROTOCOLO_CREANET P
    INNER JOIN DB2INET.TB_STATUS_PROTOCOLO_CREANET SP ON SP.CD_PROT = P.CD_PROT
    WHERE P.CD_TP_PROT IN (
        SELECT CD_TP_PROT 
        FROM DB2INET.TB_TIPO_PROTOCOLO
        WHERE NM_TP_PROT = 'Acervo Técnico'
    )
    AND SP.ATRIBUIDO IS NOT NULL
    AND LENGTH(TRIM(SP.ATRIBUIDO)) > 0
    AND P.DRAFT = 0
),
-- CTE 3: Pré-calcular mapeamento de unidades e localidades
UNIDADE_LOCALIDADE AS (
    SELECT 
        U.DESC_UNI,
        U.DESC_SIGLA,
        U.CD_UNI,
        L.LOC_NO,
        ROW_NUMBER() OVER (PARTITION BY U.DESC_UNI, U.DESC_SIGLA ORDER BY L.LOC_NU) AS RN
    FROM DB2INET.TB_UNIDADE U
    INNER JOIN DB2INET.TB_UNIDADE_LOCALIDADE UL ON UL.CD_UNI = U.CD_UNI
    INNER JOIN DB2INET.TB_LOCALIDADE L ON L.LOC_NU = UL.LOC_NU
),
-- CTE 4: Pré-calcular mapeamento de GREs
GRE_MAPPING AS (
    SELECT 
        F.SAMACCOUNTNAME,
        F.DEPARTMENT,
        UPPER(F.SAMACCOUNTNAME) AS SAM_UPPER,
        VW_GRE.GRE_SIGLA,
        ROW_NUMBER() OVER (PARTITION BY UPPER(F.SAMACCOUNTNAME) ORDER BY VW_GRE.GRE_SIGLA) AS RN
    FROM DB2INET.TB_FUNCIONARIO F
    INNER JOIN DB2INET.TB_UNIDADE U ON (U.DESC_UNI = F.DEPARTMENT OR U.DESC_SIGLA = F.DEPARTMENT)
    INNER JOIN DB2INET.VW_UNIDADES_GRES VW_GRE ON U.DESC_SIGLA = VW_GRE.SIGLA_UNI
    WHERE COALESCE(F.DELETED, 0) = 0
),
-- CTE 5: Query principal combinada e otimizada
PROTOCOLO_COMPLETO AS (
    SELECT
        -- Dados básicos do protocolo
        P.NR_PROT,
        P.DT_ABERTURA,
        P.DT_EST_CONCLUSAO,
        P.CD_TP_PROT,
        P.CD_SUBTP_PROT,
        P.FINISHED,
        P.CD_PROT,
        
        -- Dados do status (do último status)
        US.DS_OBSERVACOES,
        US.DT_STATUS,
        US.ATRIBUIDO,
        US.CD_TP_STATUS_PROT,
        
        -- Formatações de data (calculadas uma vez)
        TO_CHAR(P.DT_ABERTURA,'DD/MM/YYYY') AS DATA_ABERTURA_FMT,
        TO_CHAR(P.DT_EST_CONCLUSAO,'DD/MM/YYYY') AS DATA_EST_CONCLUSAO_FMT,
        TO_CHAR(US.DT_STATUS,'DD/MM/YYYY') AS DT_STATUS_FMT,
        
        -- Cálculos de dias (uma vez só)
        DAYS(P.DT_ABERTURA) AS DAYS_ABERTURA,
        DAYS(US.DT_STATUS) AS DAYS_STATUS,
        DAYS(CURRENT DATE) AS DAYS_CURRENT,
        (DAYS(CURRENT DATE) - DAYS(P.DT_ABERTURA)) AS DIAS_DESDE_ABERTURA,
        
        -- Dados de tipos e subtipos
        TP.NM_TP_PROT,
        STP.NM_SUBTP_PROT,
        TSP.DS_STATUS,
        
        -- Dados do funcionário
        F.DEPARTMENT,
        F.SAMACCOUNTNAME,
        
        -- Dados da GRE (da view)
        GRES.GRE_DESC,
        
        -- Dados do boleto
        BOLETO.NR_BOLETO,
        BOLETO.DT_PAGAMENTO,
        TO_CHAR(BOLETO.NR_BOLETO) AS NR_BOLETO_FMT,
        TO_CHAR(BOLETO.DT_PAGAMENTO,'DD/MM/YYYY') AS DT_PAGAMENTO_FMT,
        DAYS(BOLETO.DT_PAGAMENTO) AS DAYS_PAGAMENTO,
        
        -- Cidade (via LEFT JOIN ao invés de subconsulta)
        UL.LOC_NO AS CIDADE,
        
        -- GRE mapeada
        GM.GRE_SIGLA AS GRE_FROM_MAPPING,
        
        -- Verificação de Acervo
        FA.ATRIBUIDO_UPPER AS TEM_ACERVO,
        
        -- Atribuído upper (calculado uma vez)
        UPPER(US.ATRIBUIDO) AS ATRIBUIDO_UPPER,
        
        -- SLA_OFICIAL calculado uma vez aqui
        CASE
            WHEN STP.NM_SUBTP_PROT = 'Alteração de Registro de Empresa' THEN 20
            WHEN STP.NM_SUBTP_PROT IN ('Baixa Art - BAIXA DO RESP. PERANTE EMPR. CONTRATADA',
                                        'Baixa Art - PARALISAÇÃO DA OBRA/SERVIÇO',
                                        'Baixa Art - RESCISÃO CONTRATUAL',
                                        'Baixa Art - SUBSTITUIÇÃO DO RESPONSÁVEL TÉCNICO') THEN 10
            WHEN STP.NM_SUBTP_PROT = 'CADASTRO DE IES' THEN 15
            WHEN STP.NM_SUBTP_PROT = 'CADASTRO DE RESPONSAVEL IES' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'Cancelamento de Registro de Empresa' THEN 20
            WHEN STP.NM_SUBTP_PROT IN ('Cancelar Art - CONTRATO NÃO FOI EXECUTADO',
                                        'Cancelar Art - DUPLICIDADE DE PAGAMENTO - DN Nº 85/2011',
                                        'Cancelar Art - NENHUMA DAS ATIVIDADES TÉCNICAS FORAM EXECUTADAS') THEN 10
            WHEN STP.NM_SUBTP_PROT IN ('CAT Com Registro de Atestado - Atividade Concluída',
                                        'CAT Com Registro de Atestado - Atividade em Andamento',
                                        'CAT com Registro de Atestado - Complementar',
                                        'CAT de atividade desenvolvida no exterior',
                                        'CAT Sem Registro de Atestado') THEN 20
            WHEN STP.NM_SUBTP_PROT = 'DESCONTO DE ANUIDADE' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'ENVIO DE LISTA DE FORMANDOS' THEN 15
            WHEN STP.NM_SUBTP_PROT = 'Interrupção de Registro' THEN 15
            WHEN STP.NM_SUBTP_PROT = 'Interrupção de Registro de Empresa' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'PREMIAÇÃO DICENTE' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'Reativar Registro' THEN 15
            WHEN STP.NM_SUBTP_PROT = 'REEMBOLSO DE TAXA' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'Registro com atestado - RU' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'Registro com atestado CREANET' THEN 15
            WHEN STP.NM_SUBTP_PROT = 'Registro com diploma - RU' THEN 15
            WHEN STP.NM_SUBTP_PROT = 'Registro com diploma CREANET' THEN 15
            WHEN STP.NM_SUBTP_PROT = 'Registro de Empresa' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'REGISTRO E ATUALIZAÇÃO DE CURSO' THEN 15
            WHEN STP.NM_SUBTP_PROT = 'Segunda Via' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'Substituição de CAT com Novo Atestado' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'Validação Prévia para Cartório em Instrumento de Constituição, Alteração ou Dissolução' THEN 20
            WHEN STP.NM_SUBTP_PROT = 'Visto de Profissional' THEN 15
            ELSE 20  -- Padrão para subtipos não mapeados
        END AS SLA_OFICIAL
        
    FROM DB2INET.TB_PROTOCOLO_CREANET P
    INNER JOIN ULTIMO_STATUS US ON US.CD_PROT = P.CD_PROT AND US.RN = 1
    INNER JOIN DB2INET.TB_TIPO_PROTOCOLO TP ON P.CD_TP_PROT = TP.CD_TP_PROT
    INNER JOIN DB2INET.TB_SUBTIPO_PROTOCOLO STP ON P.CD_SUBTP_PROT = STP.CD_SUBTP_PROT
    INNER JOIN DB2INET.TB_TIPO_STATUS_PROTOCOLO TSP ON TSP.CD_TP_STATUS_PROT = US.CD_TP_STATUS_PROT
    LEFT JOIN DB2INET.TB_FUNCIONARIO F ON UPPER(F.SAMACCOUNTNAME) = UPPER(US.ATRIBUIDO) AND F.DELETED = 0
    LEFT JOIN DB2INET.TB_BOLETO BOLETO ON BOLETO.CD_PROC = P.NR_PROT
    LEFT JOIN DB2INET.VW_UNIDADES_GRES GRES ON GRES.DESC_UNI = F.DEPARTMENT
    LEFT JOIN UNIDADE_LOCALIDADE UL ON (UL.DESC_UNI = F.DEPARTMENT OR UL.DESC_SIGLA = F.DEPARTMENT) AND UL.RN = 1
    LEFT JOIN GRE_MAPPING GM ON GM.SAM_UPPER = UPPER(US.ATRIBUIDO) AND GM.RN = 1
    LEFT JOIN FUNCIONARIOS_ACERVO FA ON FA.ATRIBUIDO_UPPER = UPPER(US.ATRIBUIDO)
    WHERE P.DRAFT = 0
)

-- SELECT final 
SELECT
    NR_PROT,
    DATA_ABERTURA_FMT AS DATA_ABERTURA,
    DATA_EST_CONCLUSAO_FMT AS DATA_EST_CONCLUSAO,
    NM_TP_PROT,
    NM_SUBTP_PROT,
    
    -- DS_STATUS 
    CASE
        -- Quando tem pagamento, está finalizado e DT_STATUS < DT_PAGAMENTO
        WHEN DT_PAGAMENTO IS NOT NULL AND FINISHED = 1 AND DAYS_STATUS < DAYS_PAGAMENTO
            THEN 'Solicitação Cancelada'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NULL AND DS_STATUS = 'Solicitação Enviada'
            THEN 'Aguardando Pagamento'
        WHEN NR_BOLETO IS NULL AND FINISHED = 0 AND DS_STATUS = 'Solicitação Enviada'
            THEN 'Aguardando Análise'
        ELSE DS_STATUS
    END AS DS_STATUS,
    
    -- DS_STATUS_Simplificada
    CASE
        WHEN DS_STATUS = 'Solicitação Deferida' THEN 'Solicitação Deferida'
        WHEN DS_STATUS = 'Solicitação Cancelada' THEN 'Solicitação Cancelada'
        WHEN DS_STATUS = 'Solicitação Indeferida' THEN 'Solicitação Indeferida'
        WHEN DS_STATUS = 'Aguardando Análise' THEN 'Aguardando Análise'
        WHEN DS_STATUS = 'Aguardando doctos. da IE' THEN 'Aguardando doctos. da IE'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Aguardando Pagamento'
        WHEN DS_STATUS = 'Solicitação enviada à câmara especializada' THEN 'Solicitação enviada à câmara especializada'
        WHEN DS_STATUS = 'Exigência Atendida' THEN 'Aguardando Análise'
        WHEN DS_STATUS = 'Análise Aprovada' THEN 'Aguardando Análise'
        WHEN DS_STATUS = 'Documentação Pendente - Ver Exigências/Observações' THEN 'Exigência'
        WHEN DS_STATUS = 'Solicitação Aguardando Retorno Banco' THEN 'Aguardando Pagamento'
        WHEN DS_STATUS = 'Solicitação Enviada' THEN 'Aguardando Pagamento'
        ELSE DS_STATUS
    END AS DS_STATUS_Simplificada,
    
    -- DS_STATUS_Classificacao
    CASE
        WHEN DS_STATUS IN ('Solicitação Deferida', 'Solicitação Cancelada', 'Solicitação Indeferida') THEN 'Fechado'
        WHEN DS_STATUS IN ('Exigência Atendida', 'Documentação Pendente - Ver Exigências/Observações') THEN 'Exigência'
        ELSE 'Aberto'
    END AS DS_STATUS_Classificacao,
    
    DS_OBSERVACOES,
    DT_STATUS_FMT AS DT_STATUS,
    ATRIBUIDO,
    CASE WHEN FINISHED = 1 THEN 'SIM' ELSE 'NÃO' END AS FINALIZADO,
    DEPARTMENT AS UNIDADE,
    GRE_DESC AS REGIONAL,
    CIDADE,
    
    -- SLA_PROTOCOLO 
    CASE
        -- Cancelado por não pagamento
        WHEN DS_STATUS = 'Solicitação Cancelada' 
             AND FINISHED = 1 
             AND DS_OBSERVACOES LIKE '%Boleto Vencido%'
        THEN 0
        
        -- Quando tem pagamento, está finalizado e DT_STATUS < DT_PAGAMENTO
        WHEN DT_PAGAMENTO IS NOT NULL AND FINISHED = 1 AND DAYS_STATUS < DAYS_PAGAMENTO 
        THEN 0
        
        -- Quando NM_TP_PROT = 'Empresa' E NM_SUBTP_PROT = 'Registro de Empresa' E DS_STATUS = 'Solicitação Deferida'
        WHEN NM_TP_PROT = 'Empresa' AND NM_SUBTP_PROT = 'Registro de Empresa' AND DS_STATUS = 'Solicitação Deferida' 
        THEN 0
        
        -- Cálculo padrão do SLA
        WHEN DAYS_PAGAMENTO IS NOT NULL THEN
            CASE
                WHEN FINISHED = 1 THEN DAYS_STATUS - DAYS_PAGAMENTO
                ELSE DAYS_CURRENT - DAYS_PAGAMENTO
            END
        ELSE
            CASE
                WHEN FINISHED = 1 THEN DAYS_STATUS - DAYS_ABERTURA
                ELSE DAYS_CURRENT - DAYS_ABERTURA
            END
    END AS SLA,
    
    -- SLA_OFICIAL (já calculado na CTE)
    SLA_OFICIAL,
    
    -- CATEGORIA_STATUS CORRIGIDA com nova lógica baseada em SLA_OFICIAL
    CASE
        -- Cancelado por não pagamento
        WHEN DS_STATUS = 'Solicitação Cancelada' 
             AND FINISHED = 1 
             AND DS_OBSERVACOES LIKE '%Boleto Vencido%'
        THEN 'Cancelado por não pagamento'
        
        -- Sem pagamento
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) 
             AND DT_PAGAMENTO IS NULL 
             AND NR_BOLETO IS NOT NULL
        THEN 'Sem pagamento'
        
        -- NOVA LÓGICA: Comparação com SLA_OFICIAL
        WHEN (CASE
                WHEN DAYS_PAGAMENTO IS NOT NULL AND FINISHED = 1 
                    THEN DAYS_STATUS - DAYS_PAGAMENTO
                WHEN DAYS_PAGAMENTO IS NOT NULL 
                    THEN DAYS_CURRENT - DAYS_PAGAMENTO
                WHEN FINISHED = 1 
                    THEN DAYS_STATUS - DAYS_ABERTURA
                ELSE DAYS_CURRENT - DAYS_ABERTURA
             END) <= SLA_OFICIAL
        THEN 'Dentro do Prazo'
        ELSE 'Fora do Prazo'
    END AS CATEGORIA_STATUS,
    
    NR_BOLETO_FMT AS NR_BOLETO,
    DT_PAGAMENTO_FMT AS DT_PAGAMENTO,
    
    -- GRE (lógica completa mantida)
    CASE
        -- Cancelado por não pagamento
        WHEN DS_STATUS = 'Solicitação Cancelada' 
             AND FINISHED = 1 
             AND DS_OBSERVACOES LIKE '%Boleto Vencido%'
        THEN 'Cancelado por não pagamento'
        
        -- Funcionário com Acervo
        WHEN TEM_ACERVO IS NOT NULL
        THEN 'ACERVO'
        
        -- Sem distribuição
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        
        -- Não atribuído ou Login = 0
        WHEN COALESCE(DS_OBSERVACOES, '') = '' 
            OR COALESCE(ATRIBUIDO, '') = ''
            OR ATRIBUIDO = '0'
        THEN
            CASE
                WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) 
                     AND DT_PAGAMENTO IS NULL 
                     AND NR_BOLETO IS NOT NULL
                THEN 'Sem pagamento'
                ELSE 'Protocolo ainda não atribuído a um agente'
            END
        
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END AS GRE,
    
    -- DT_FINALIZACAO
    CASE
        WHEN DS_STATUS IN ('Solicitação Deferida', 'Solicitação Cancelada', 'Solicitação Indeferida')
        THEN DT_STATUS_FMT
        ELSE NULL
    END AS DT_FINALIZACAO,
    
    -- GRE_Simplificada CORRIGIDA (com ATENDIMENTO → ACERVO)
    CASE
        -- Cancelado por não pagamento
        WHEN DS_STATUS = 'Solicitação Cancelada' 
             AND FINISHED = 1 
             AND DS_OBSERVACOES LIKE '%Boleto Vencido%'
        THEN 'Cancelado por não pagamento'
        
        -- Funcionário com Acervo
        WHEN TEM_ACERVO IS NOT NULL 
        THEN 'ACERVO'
        
        -- Sem distribuição
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        
        -- Aguardando Pagamento vira Sem distribuição
        WHEN DS_STATUS = 'Aguardando Pagamento' 
        THEN 'Sem distribuição'
        
        -- GREs padrão
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE5' THEN 'GRE5'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE12' THEN 'GRE12'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE2' THEN 'GRE2'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE7' THEN 'GRE7'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE9' THEN 'GRE9'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE10' THEN 'GRE10'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE11' THEN 'GRE11'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE3' THEN 'GRE3'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE4' THEN 'GRE4'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE1' THEN 'GRE1'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE8' THEN 'GRE8'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GRE6' THEN 'GRE6'
        
        -- Status especiais
        WHEN COALESCE(DS_OBSERVACOES, '') = '' 
            OR COALESCE(ATRIBUIDO, '') = ''
            OR ATRIBUIDO = '0'
        THEN 'Sem distribuição'
        
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) 
             AND DT_PAGAMENTO IS NULL 
             AND NR_BOLETO IS NOT NULL
        THEN 'CANCELADO SEM PAGTO'
        
        -- Departamentos (CORRIGIDO: ATENDIMENTO → ACERVO)
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' 
        THEN 'ACERVO'  -- CORRIGIDO: Era 'ATENDIMENTO', agora é 'ACERVO'
        
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        
        -- Casos especiais
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END AS GRE_Simplificada

FROM PROTOCOLO_COMPLETO

-- WHERE otimizado com condições simplificadas e COMPLETAS
WHERE 
    -- Primeiro filtro: valores exatos que devem ser excluídos
    CASE
        -- Repetir toda a lógica de GRE_Simplificada para o WHERE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END NOT IN (
        'SEM CLASSIFICAÇÃO',
        'PRESIDÊNCIA',
        'EISI',
        'GDEP',
        'GFISC',
        'GERENCIA DE DES. E EXECUÇÃO DE PROJETOS - GDEP',
        'GERENCIA DE FISCALIZAÇÃO E PROCEDIMENTOS - GFISC',
        'ADM DADOS',
        'CONSULTA TÉCNICA',
        'EQUIPE OPERAÇÃO',
        'GEJ',
        'JURÍDICO'
    )
    
    -- Segundo filtro: exclusões por conteúdo (LIKE)
    AND UPPER(CASE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END) NOT LIKE '%ADM DE DADOS%'
    
    AND UPPER(CASE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END) NOT LIKE '%CONSULTA TÉCNICA%'
    
    AND UPPER(CASE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END) NOT LIKE '%CONSULTA TECNICA%'
    
    AND UPPER(CASE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END) NOT LIKE '%EQUIPE OPERAÇÃO%'
    
    AND UPPER(CASE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END) NOT LIKE '%EQUIPE OPERACAO%'
    
    AND UPPER(CASE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END) NOT LIKE '%GEJ%'
    
    AND UPPER(CASE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END) NOT LIKE '%GDEP%'
    
    AND UPPER(CASE
        WHEN DS_STATUS = 'Solicitação Cancelada' AND FINISHED = 1 AND DS_OBSERVACOES LIKE '%Boleto Vencido%' THEN 'Cancelado por não pagamento'
        WHEN TEM_ACERVO IS NOT NULL THEN 'ACERVO'
        WHEN NR_BOLETO IS NOT NULL AND DT_PAGAMENTO IS NOT NULL
            AND COALESCE(DEPARTMENT, '') = ''
            AND COALESCE(GRE_DESC, '') = ''
            AND COALESCE(CIDADE, '') = ''
            AND COALESCE(ATRIBUIDO, '') = ''
        THEN 'Sem distribuição'
        WHEN DS_STATUS = 'Aguardando Pagamento' THEN 'Sem distribuição'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('GRE1','GRE2','GRE3','GRE4','GRE5','GRE6','GRE7','GRE8','GRE9','GRE10','GRE11','GRE12')
            THEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
        WHEN COALESCE(DS_OBSERVACOES, '') = '' OR COALESCE(ATRIBUIDO, '') = '' OR ATRIBUIDO = '0'
            THEN 'Sem distribuição'
        WHEN DAYS_CURRENT > DAYS(DT_EST_CONCLUSAO) AND DT_PAGAMENTO IS NULL AND NR_BOLETO IS NOT NULL
            THEN 'CANCELADO SEM PAGTO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE ATEND. AOS PROF, EMP. E INST DE ENSINO' THEN 'ACERVO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE DESENVOLVIMENTO E ADMINISTRACAO DE DADOS' THEN 'ADM DADOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UPS SANTOS' THEN 'UPS SANTOS'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE CAMARAS ESPECIALIZADAS E CONSULTAS TECNICA' THEN 'CONSULTA TÉCNICA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GABINETE DA PRESIDENCIA' THEN 'PRESIDÊNCIA'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE FINANCEIRA E CONTABIL - UFC' THEN 'UFC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UNIDADE DE PARCERIA E RELACOES INSTITUCIONAIS - UR' THEN 'UR'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) IN ('EQUIPE DE SERV ACERVO TECNICO E OPERACIONAL, PROTO',
                                                          'EQUIPE DE SERV ACERVO TÉCNICO E OPERACIONAL, PROTO') THEN 'ACERVO TÉCNICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE EXPERIENCIA E JORNADA - GEJ' THEN 'GEJ'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE FISCALIZACAO E PROCEDIMENTOS - GFISC' THEN 'GFISC'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'UGI REGISTRO' THEN 'UGI REGISTRO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EISI' THEN 'EISI'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'EQUIPE DE OPERACAO, QUALIDADE E SUCESSO DO CLIENTE' THEN 'EQUIPE OPERAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE ASSUNTOS JURIDICOS' THEN 'JURÍDICO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT) = 'GERENCIA DE DES. E EXECUCAO DE PROJETOS - GDEP' THEN 'GDEP'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('NÃO ATRIBUÍDO', 'NAO ATRIBUIDO') THEN 'Sem distribuição'
        WHEN UPPER(TRIM(COALESCE(GRE_FROM_MAPPING, DEPARTMENT, ''))) IN ('SEM CLASSIFICAÇÃO', 'SEM CLASSIFICACAO') THEN 'SEM CLASSIFICAÇÃO'
        WHEN COALESCE(GRE_FROM_MAPPING, DEPARTMENT, '') = '' THEN 'Sem distribuição'
        ELSE COALESCE(GRE_FROM_MAPPING, DEPARTMENT)
    END) NOT LIKE '%GFISC%'

WITH UR
--    AND (@IN_FINISHED IS NULL OR FINISHED = @IN_FINISHED)
--    AND CD_TP_PROT = @IN_CD_TP_PROT
--    AND (@IN_CD_SUBTP_PROT IS NULL OR CD_SUBTP_PROT = @IN_CD_SUBTP_PROT)
--    AND (@IN_CD_TP_STATUS_PROT IS NULL OR CD_TP_STATUS_PROT = @IN_CD_TP_STATUS_PROT)

-- Limitar resultado se necessário
-- FETCH FIRST 1000 ROWS ONLY
;
```

## Estrutura da Documentação

### Colunas de Saída

Cada coluna possui uma página dedicada com explicação detalhada sobre sua origem, regras de negócio aplicadas e exemplos práticos:

1. **[NR_PROT](./colunas/NR_PROT.md)** - Número do protocolo
2. **[DATA_ABERTURA](./colunas/DATA_ABERTURA.md)** - Data de abertura do protocolo
3. **[DATA_EST_CONCLUSAO](./colunas/DATA_EST_CONCLUSAO.md)** - Data estimada de conclusão
4. **[NM_TP_PROT](./colunas/NM_TP_PROT.md)** - Nome do tipo de protocolo
5. **[NM_SUBTP_PROT](./colunas/NM_SUBTP_PROT.md)** - Nome do subtipo de protocolo
6. **[DS_STATUS](./colunas/DS_STATUS.md)** - Descrição do status com regras complexas
7. **[DS_STATUS_SIMPLIFICADA](./colunas/DS_STATUS_SIMPLIFICADA.md)** - Status simplificado para análise
8. **[DS_STATUS_CLASSIFICACAO](./colunas/DS_STATUS_CLASSIFICACAO.md)** - Classificação do status (Aberto/Fechado/Exigência)
9. **[DS_OBSERVACOES](./colunas/DS_OBSERVACOES.md)** - Observações do protocolo
10. **[DT_STATUS](./colunas/DT_STATUS.md)** - Data do último status
11. **[ATRIBUIDO](./colunas/ATRIBUIDO.md)** - Funcionário responsável pelo protocolo
12. **[FINALIZADO](./colunas/FINALIZADO.md)** - Indicador de finalização
13. **[UNIDADE](./colunas/UNIDADE.md)** - Unidade organizacional responsável
14. **[REGIONAL](./colunas/REGIONAL.md)** - Regional do CREA-SP
15. **[CIDADE](./colunas/CIDADE.md)** - Cidade de origem
16. **[SLA](./colunas/SLA.md)** - Cálculo do tempo de atendimento
17. **[SLA_OFICIAL](./colunas/SLA_OFICIAL.md)** - SLA oficial por tipo de serviço
18. **[CATEGORIA_STATUS](./colunas/CATEGORIA_STATUS.md)** - Categorização baseada em prazo e pagamento
19. **[NR_BOLETO](./colunas/NR_BOLETO.md)** - Número do boleto de pagamento
20. **[DT_PAGAMENTO](./colunas/DT_PAGAMENTO.md)** - Data de pagamento do boleto
21. **[GRE](./colunas/GRE.md)** - Gerência Regional com regras complexas
22. **[DT_FINALIZACAO](./colunas/DT_FINALIZACAO.md)** - Data de finalização do protocolo
23. **[GRE_SIMPLIFICADA](./colunas/GRE_SIMPLIFICADA.md)** - GRE simplificada para análise consolidada

## Tabelas Utilizadas

A query utiliza as seguintes tabelas do banco DB2INET:

- `TB_STATUS_PROTOCOLO_CREANET` - Histórico de status dos protocolos
- `TB_PROTOCOLO_CREANET` - Dados principais dos protocolos
- `TB_TIPO_PROTOCOLO` - Tipos de protocolo disponíveis
- `TB_SUBTIPO_PROTOCOLO` - Subtipos de protocolo
- `TB_TIPO_STATUS_PROTOCOLO` - Tipos de status possíveis
- `TB_FUNCIONARIO` - Cadastro de funcionários
- `TB_BOLETO` - Informações de pagamento
- `TB_UNIDADE` - Unidades organizacionais
- `TB_UNIDADE_LOCALIDADE` - Relação entre unidades e localidades
- `TB_LOCALIDADE` - Cadastro de localidades
- `VW_UNIDADES_GRES` - View de mapeamento das GREs

## Otimizações Implementadas

A query implementa diversas otimizações para melhorar a performance:

- Criação de índices específicos para as colunas mais utilizadas em JOINs e filtros
- Uso de CTEs para pré-processar dados e evitar recálculos
- ROW_NUMBER() para obter eficientemente o último status de cada protocolo
- Cálculos realizados uma única vez e reutilizados ao longo da query